<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Tracking Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Sidebar */
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar nav a {
            display: block;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: #667eea;
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 22px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
        }

        /* Activity List */
        .activity-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .activity-item:hover {
            transform: translateX(5px);
            cursor: pointer;
        }

        .activity-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .activity-location {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .activity-description {
            color: #666;
            font-size: 14px;
        }

        /* Camera Grid */
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .camera-view {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .camera-view h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .camera-view img {
            width: 100%;
            border-radius: 8px;
            background: #f0f0f0;
            min-height: 200px;
        }

        .camera-view button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .camera-view button:hover {
            background: #5568d3;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filters button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Calendar customization */
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 12px;
        }

        .fc-event {
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .camera-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <h1>üè† Life Tracking Dashboard</h1>
        <div class="navbar-right">
            <span>Welcome, {{ username }}!</span>
            <a href="/logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav>
                <a href="#" data-page="overview" class="nav-link active">üìä Overview</a>
                <a href="#" data-page="timeline" class="nav-link">üìù Timeline</a>
                <a href="#" data-page="calendar" class="nav-link">üìÖ Calendar</a>
                <a href="#" data-page="cameras" class="nav-link">üìπ Live Cameras</a>
                <a href="#" data-page="analytics" class="nav-link">üìà Analytics</a>
                <a href="#" data-page="settings" class="nav-link">‚öôÔ∏è Settings</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Page -->
            <div id="overview" class="page active">
                <h2>Dashboard Overview</h2>

                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Today's Activities</div>
                        <div class="number" id="stat-today">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">This Week</div>
                        <div class="number" id="stat-week">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Cost (Today)</div>
                        <div class="number" id="stat-cost">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Active Cameras</div>
                        <div class="number" id="stat-cameras">-</div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="card">
                    <h2>Recent Activities</h2>
                    <div class="activity-list" id="recent-activities">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading activities...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Page -->
            <div id="timeline" class="page">
                <h2>Activity Timeline</h2>

                <div class="card">
                    <div class="filters">
                        <input type="date" id="filter-from" placeholder="From Date">
                        <input type="date" id="filter-to" placeholder="To Date">
                        <select id="filter-camera">
                            <option value="">All Cameras</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="Search...">
                        <button onclick="applyFilters()">Apply Filters</button>
                        <button onclick="clearFilters()">Clear</button>
                    </div>

                    <div class="activity-list" id="timeline-activities">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading timeline...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendar-page" class="page">
                <h2>Activity Calendar</h2>
                <div class="card">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Cameras Page -->
            <div id="cameras" class="page">
                <h2>Live Camera Feeds</h2>
                <div class="camera-grid" id="camera-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading cameras...</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics" class="page">
                <h2>Analytics & Statistics</h2>

                <div class="card">
                    <h2>Activity by Room</h2>
                    <canvas id="chart-rooms"></canvas>
                </div>

                <div class="card">
                    <h2>Activity by Type</h2>
                    <canvas id="chart-activities"></canvas>
                </div>

                <div class="card">
                    <h2>24-Hour Activity Timeline</h2>
                    <canvas id="chart-timeline"></canvas>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                <h2>Settings</h2>

                <div class="card">
                    <h2>Change Password</h2>
                    <form id="change-password-form">
                        <div style="margin-bottom: 15px;">
                            <label>Current Password</label>
                            <input type="password" id="current-password" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>New Password</label>
                            <input type="password" id="new-password" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        </div>
                        <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Update Password</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Activity Detail Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.dataset.page;

                // Update active nav
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Show page
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageName).classList.add('active');

                // Load page data
                if (pageName === 'calendar-page') loadCalendar();
                if (pageName === 'cameras') loadCameras();
                if (pageName === 'timeline') loadTimeline();
                if (pageName === 'analytics') loadAnalytics();
            });
        });

        // Load overview on page load
        window.addEventListener('load', () => {
            loadOverview();
        });

        async function loadOverview() {
            // Load stats
            const statsToday = await fetch('/api/statistics?period=today').then(r => r.json());
            const statsWeek = await fetch('/api/statistics?period=week').then(r => r.json());

            document.getElementById('stat-today').textContent = statsToday.total_activities;
            document.getElementById('stat-week').textContent = statsWeek.total_activities;
            document.getElementById('stat-cost').textContent = '$' + statsToday.total_cost.toFixed(4);

            // Load cameras count
            const cameras = await fetch('/api/cameras').then(r => r.json());
            document.getElementById('stat-cameras').textContent = cameras.cameras.length;

            // Load recent activities
            const activities = await fetch('/api/activities?limit=10').then(r => r.json());
            displayActivities(activities.activities, 'recent-activities');
        }

        function displayActivities(activities, containerId) {
            const container = document.getElementById(containerId);

            if (activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No activities yet</p>';
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="activity-item" onclick="showActivityDetail(${activity.id})">
                    <div class="activity-time">${formatDate(activity.timestamp)}</div>
                    <div class="activity-location">üìç ${activity.room || 'Unknown'} (${activity.camera_name})</div>
                    <div class="activity-description">${activity.activity || 'No activity'}</div>
                    ${activity.details ? `<div class="activity-description" style="font-size: 12px; margin-top: 5px;">${activity.details}</div>` : ''}
                </div>
            `).join('');
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function showActivityDetail(id) {
            const activities = await fetch('/api/activities').then(r => r.json());
            const activity = activities.activities.find(a => a.id === id);

            if (!activity) return;

            const modal = document.getElementById('activityModal');
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                <h2>${activity.room || 'Unknown Room'}</h2>
                <p><strong>Time:</strong> ${formatDate(activity.timestamp)}</p>
                <p><strong>Camera:</strong> ${activity.camera_name}</p>
                <p><strong>Activity:</strong> ${activity.activity || 'None'}</p>
                <p><strong>Details:</strong> ${activity.details || 'None'}</p>
                <p><strong>Cost:</strong> $${activity.cost?.toFixed(4) || '0.0000'}</p>
                ${activity.image_path ? `<img src="/${activity.image_path}" style="width: 100%; border-radius: 8px; margin-top: 15px;">` : ''}
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        async function loadTimeline() {
            const activities = await fetch('/api/activities?limit=100').then(r => r.json());
            displayActivities(activities.activities, 'timeline-activities');

            // Load cameras for filter
            const cameras = await fetch('/api/cameras').then(r => r.json());
            const cameraSelect = document.getElementById('filter-camera');
            cameraSelect.innerHTML = '<option value="">All Cameras</option>' +
                cameras.cameras.map(cam => `<option value="${cam.name}">${cam.name}</option>`).join('');
        }

        async function applyFilters() {
            const from = document.getElementById('filter-from').value;
            const to = document.getElementById('filter-to').value;
            const camera = document.getElementById('filter-camera').value;
            const search = document.getElementById('filter-search').value;

            const params = new URLSearchParams();
            if (from) params.append('from', from);
            if (to) params.append('to', to);
            if (camera) params.append('camera', camera);
            if (search) params.append('search', search);

            const activities = await fetch(`/api/activities?${params}`).then(r => r.json());
            displayActivities(activities.activities, 'timeline-activities');
        }

        function clearFilters() {
            document.getElementById('filter-from').value = '';
            document.getElementById('filter-to').value = '';
            document.getElementById('filter-camera').value = '';
            document.getElementById('filter-search').value = '';
            loadTimeline();
        }

        let calendar;
        async function loadCalendar() {
            if (calendar) {
                calendar.refetchEvents();
                return;
            }

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: async (info, successCallback) => {
                    const events = await fetch(`/api/calendar?from=${info.startStr}&to=${info.endStr}`).then(r => r.json());
                    successCallback(events);
                },
                eventClick: (info) => {
                    showActivityDetail(info.event.id);
                }
            });

            calendar.render();
        }

        async function loadCameras() {
            const cameras = await fetch('/api/cameras').then(r => r.json());
            const grid = document.getElementById('camera-grid');

            grid.innerHTML = cameras.cameras.map(camera => `
                <div class="camera-view">
                    <h3>${camera.name}</h3>
                    <img id="camera-${camera.name}" src="" alt="${camera.name}">
                    <button onclick="refreshCamera('${camera.name}')">üîÑ Refresh Live</button>
                </div>
            `).join('');

            // Load initial snapshots
            cameras.cameras.forEach(camera => {
                loadCameraSnapshot(camera.name);
            });
        }

        async function loadCameraSnapshot(cameraName) {
            try {
                const data = await fetch(`/api/camera/snapshot/${cameraName}`).then(r => r.json());
                if (data.success) {
                    document.getElementById(`camera-${cameraName}`).src = data.image;
                }
            } catch (e) {
                console.error('Failed to load snapshot:', e);
            }
        }

        async function refreshCamera(cameraName) {
            const img = document.getElementById(`camera-${cameraName}`);
            const imgContainer = img.parentElement;

            // Show loading state
            img.src = '';
            img.style.background = '#f0f0f0';

            // Remove existing error message if any
            const existingError = imgContainer.querySelector('.camera-error');
            if (existingError) existingError.remove();

            try {
                const data = await fetch(`/api/camera/live/${cameraName}`).then(r => r.json());
                if (data.success) {
                    img.src = data.image;
                } else {
                    // Show detailed error message on the page
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'camera-error';
                    errorDiv.style.cssText = 'background: #fee; border: 2px solid #fcc; border-radius: 8px; padding: 15px; margin-top: 10px; color: #c33;';

                    errorDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px;">‚ùå ${data.error}</div>
                        ${data.details ? `<div style="font-size: 14px; margin-bottom: 8px;">${data.details}</div>` : ''}
                        ${data.rtsp_url ? `<div style="font-size: 12px; color: #999; margin-top: 8px;">RTSP URL: ${data.rtsp_url}</div>` : ''}
                        <div style="font-size: 12px; margin-top: 10px;">
                            <strong>Troubleshooting:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                <li>Verify camera is powered on</li>
                                <li>Check IP address in config.json</li>
                                <li>Test RTSP URL in VLC Media Player</li>
                                <li>Verify network connection</li>
                            </ul>
                        </div>
                    `;

                    imgContainer.appendChild(errorDiv);

                    // Set placeholder image
                    img.alt = 'Camera offline';
                }
            } catch (e) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'camera-error';
                errorDiv.style.cssText = 'background: #fee; border: 2px solid #fcc; border-radius: 8px; padding: 15px; margin-top: 10px; color: #c33;';
                errorDiv.innerHTML = `
                    <div style="font-weight: bold;">‚ùå Network Error</div>
                    <div style="font-size: 14px; margin-top: 5px;">${e.message}</div>
                `;
                imgContainer.appendChild(errorDiv);
            }
        }

        let chartsLoaded = false;
        async function loadAnalytics() {
            if (chartsLoaded) return;
            chartsLoaded = true;

            const stats = await fetch('/api/statistics?period=week').then(r => r.json());

            // Rooms chart
            new Chart(document.getElementById('chart-rooms'), {
                type: 'bar',
                data: {
                    labels: stats.by_room.map(r => r.room),
                    datasets: [{
                        label: 'Activities by Room',
                        data: stats.by_room.map(r => r.count),
                        backgroundColor: '#667eea'
                    }]
                }
            });

            // Activities chart
            new Chart(document.getElementById('chart-activities'), {
                type: 'doughnut',
                data: {
                    labels: stats.by_activity.map(a => a.activity),
                    datasets: [{
                        data: stats.by_activity.map(a => a.count),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
                    }]
                }
            });

            // Timeline chart
            new Chart(document.getElementById('chart-timeline'), {
                type: 'line',
                data: {
                    labels: stats.timeline.map(t => t.hour),
                    datasets: [{
                        label: 'Activities per Hour',
                        data: stats.timeline.map(t => t.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true
                    }]
                }
            });
        }

        // Change password
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const current = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;

            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_password: current,
                    new_password: newPass
                })
            }).then(r => r.json());

            if (response.success) {
                alert('Password changed successfully!');
                document.getElementById('change-password-form').reset();
            } else {
                alert('Error: ' + response.error);
            }
        });

        // Close modal on outside click
        window.onclick = (event) => {
            const modal = document.getElementById('activityModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
